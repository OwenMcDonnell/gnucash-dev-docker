# gnucash-dev-docker: Docker containers for automated OS setup and dev/build environ for GnuCash v3+ binaries and docs
# Copyright (C) 2019 Dale Phurrough <dale@hidale.com>

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

parameters:
  GNC_GIT_CHECKOUT: ''
  OS_DISTLIST: |
    ubuntu-14.04
    ubuntu-16.04
    ubuntu-18.04
    ubuntu-19.04
    debian-8
    debian-9
    debian-10
    archlinux
    centos-7
    opensuse-15.0
    opensuse-15.1
    fedora-28
    fedora-29
    fedora-30

stages:
- stage: buildTestStage
  displayName: Build Test
  variables:
    GNC_GIT_CHECKOUT: ${{ parameters.GNC_GIT_CHECKOUT }}
    OS_DISTLIST: ${{ parameters.OS_DISTLIST }}
  jobs:
  - job: generateJob
    displayName: '- Generating'
    pool:
      vmImage: 'ubuntu-latest'
    timeoutInMinutes: 5
    cancelTimeoutInMinutes: 1
    steps:
    - checkout: none
    - script: |
        # needed for when these CI files are in a separate repo than the core GnuCash repo
        set -e
        curl --silent --fail --location --retry 3 --connect-timeout 5 "https://api.github.com/repos/gnucash/gnucash/commits/${GNC_GIT_CHECKOUT}" > gnccommit.json
        if [[ ("$?" != "0") || ! -s gnccommit.json ]]; then
          echo "Error retrieving GnuCash git commit from GitHub with GNC_GIT_CHECKOUT=${GNC_GIT_CHECKOUT}" >&2
          exit 1
        fi
        OBJECTHASH="$(jq --raw-output '.sha' < gnccommit.json)"
        if [[ -z "$OBJECTHASH" ]]; then
          echo 'Error. Unable to parse GitHub commit json for sha hash' >&2
          exit 1
        fi
        echo "##vso[task.setVariable variable=hash;isOutput=true]${OBJECTHASH}"
        echo "GnuCash commit ${OBJECTHASH} locked across these builds where GNC_GIT_CHECKOUT=${GNC_GIT_CHECKOUT}"
      name: gnccommit
      displayName: Resolve GnuCash commit hash
    - script: |
        MTRX=$(jq --null-input --compact-output 'env.OS_DISTLIST | split("\n") | map(select(. != "")) | map({(.|gsub("\\W";"_")): {"OS_DISTTAG": .}}) | add')
        echo "##vso[task.setVariable variable=buildVariables;isOutput=true]${MTRX}"
        echo "$MTRX"
      name: mtrx
      displayName: Generate matrix of OS versions

  - job: buildTestJob
    displayName: '-'
    dependsOn: generateJob
    strategy:
      maxParallel: 8
      matrix: $[dependencies.generateJob.outputs['mtrx.buildVariables']]
    condition: |
      and(
        succeeded(),
        or(
          ne(variables['Build.Reason'], 'PullRequest'),
          in(variables['OS_DISTTAG'], 'ubuntu-14.04', 'archlinux')
        )
      )
    continueOnError: true  # 'true' if future jobs should run even if this job fails; defaults to 'false'
    pool:
      vmImage: 'ubuntu-latest'
    timeoutInMinutes: 30
    cancelTimeoutInMinutes: 2
    variables:
      GNC_EXIT_WITH_RESULT: '1'
      PLATFORM_CMAKE_OPTS: '-DCMAKE_INSTALL_PREFIX=/opt -DWITH_PYTHON=ON'
      DOCKERHUBUSER: 'diablodale'
      DOCKERHUBREPO: 'gnucashbuilder'
      GNC_GIT_CHECKOUT: $[dependencies.generateJob.outputs['gnccommit.hash']]
    steps:
    - checkout: none
    - script: |
        docker pull "${DOCKERHUBUSER}/${DOCKERHUBREPO}:${OS_DISTTAG}"
      displayName: Download Docker image
    - script: |
        docker run \
        --name ${DOCKERHUBREPO}-${OS_DISTTAG} \
        --detach \
        --env GNC_GIT_CHECKOUT \
        --env PLATFORM_CMAKE_OPTS \
        --env GNC_EXIT_WITH_RESULT \
        "${DOCKERHUBUSER}/${DOCKERHUBREPO}:${OS_DISTTAG}" \
        tail -f /dev/null
      displayName: Start Docker container
    - script: |
        docker exec \
        --env GNC_PHASES=build \
        ${DOCKERHUBREPO}-${OS_DISTTAG} \
        /commonbuild
      displayName: Build
    - script: |
        docker exec \
        --env GNC_PHASES=install \
        ${DOCKERHUBREPO}-${OS_DISTTAG} \
        /commonbuild
      displayName: Install
      continueOnError: true
    - script: |
        docker exec \
        --env GNC_PHASES=test \
        ${DOCKERHUBREPO}-${OS_DISTTAG} \
        /commonbuild
      displayName: Test
      continueOnError: true
    - script: |
        docker cp \
        "${DOCKERHUBREPO}-${OS_DISTTAG}:/build/Testing" \
        ./
      displayName: Retrieve Test Report
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: cTest
        testResultsFiles: 'Testing/*/Test.xml'
        testRunTitle: $(OS_DISTTAG) unit tests
        publishRunAttachments: true
    - script: |
        docker rm \
        --force \
        ${DOCKERHUBREPO}-${OS_DISTTAG}
      displayName: Remove Docker container
